{% extends "base.html" %}

{% block title %}Sign Attendance - Attendance Tracker{% endblock %}

{% block content %}
<div style="max-width: 500px; margin: 0 auto;">
    <!-- Current Meeting Info -->
    {% if active_session and active_location %}
    <div style="background: linear-gradient(135deg, #007bff, #0056b3); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: white; box-shadow: 0 4px 15px rgba(0,123,255,0.3);">
        <h2 style="color: white; margin: 0 0 10px 0; font-size: 1.4rem;">üìç {{ active_session.meeting_name }}</h2>
        <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">
            üéØ Attendance Zone: {{ active_location.radius_meters }}m radius
        </p>
        <p style="color: rgba(255,255,255,0.7); margin: 5px 0 0 0; font-size: 12px;">
            Started: {{ active_session.start_time.strftime('%H:%M on %b %d') }}
        </p>
    </div>
    {% else %}
    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <h2 style="color: #721c24; margin: 0 0 10px 0;">‚ö†Ô∏è No Active Meeting</h2>
        <p style="margin: 0;">This meeting session has ended. Please check with the organizer.</p>
    </div>
    {% endif %}

    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #007bff; margin-bottom: 10px;">‚úçÔ∏è Sign Attendance</h1>
        <p style="color: #666; font-size: 16px;">Please fill out all fields to record your attendance</p>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
                    <strong>‚ö†Ô∏è Notice:</strong> {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <form method="POST" action="/submit-attendance">
            <div class="form-group">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <div id="locationError" style="display:none; background:#f8d7da; color:#721c24; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; font-size:15px;">‚ö†Ô∏è Location not detected. Please enable location services and reload the page.</div>
                <div id="distanceInfo" style="display:none; background:#e2e3e5; color:#383d41; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; font-size:15px;"></div>
                <div class="form-group">
                <label for="firstname">üìù First Name:</label>
                <input type="text" id="firstname" name="firstname" required 
                       placeholder="Enter your first name">
            </div>
            
            <div class="form-group">
                <label for="lastname">üìù Last Name:</label>
                <input type="text" id="lastname" name="lastname" required 
                       placeholder="Enter your last name">
            </div>
            
            <div class="form-group">
                <label for="surname">üë§ Surname:</label>
                <input type="text" id="surname" name="surname" required 
                       placeholder="Enter your surname">
            </div>
            
            <div class="form-group">
                <label for="email">üìß Email Address:</label>
                <input type="email" id="email" name="email" required 
                       placeholder="your.email@example.com">
            </div>
            
            <div class="form-group">
                <label for="phone">üì± Phone Number:</label>
                <input type="tel" id="phone" name="phone" required 
                       placeholder="Enter your phone number">
            </div>
            
            <div class="form-group">
                <label for="zone">üèõÔ∏è Zone:</label>
                <select id="zone" name="zone" required>
                    <option value="">Select your zone</option>
                    <option value="MCA">MCA</option>
                    <option value="ZONE 1">ZONE 1</option>
                    <option value="ZONE 2">ZONE 2</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="group_name">üë• Group:</label>
                <select id="group_name" name="group_name" required>
                    <option value="">Select your group</option>
                    <option value="VIRTUOUS">VIRTUOUS</option>
                    <option value="AUXANO">AUXANO</option>
                    <option value="MIMSHACK">MIMSHACK</option>
                    <option value="PLEROMA">PLEROMA</option>
                    <option value="AIRPORT ROAD">AIRPORT ROAD</option>
                    <option value="GARKI">GARKI</option>
                    <option value="SILVERBIRD">SILVERBIRD</option>
                    <option value="WUSE">WUSE</option>
                    <option value="ASOKORO">ASOKORO</option>
                    <option value="GWARINPA">GWARINPA</option>
                    <option value="KARU">KARU</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="church">‚õ™ Church:</label>
                <input type="text" id="church" name="church" required 
                       placeholder="Enter your church name">
            </div>
            
            <div class="form-group">
                <label for="category">üéØ Category:</label>
                <select id="category" name="category" required>
                    <option value="">Select your category</option>
                    <option value="Leader">Leader</option>
                    <option value="Member">Member</option>
                    <option value="Volunteer">Volunteer</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBtn" style="margin-top: 20px;">
                ‚úÖ Submit Attendance
            </button>
        </form>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
        <p>üîí Your information is secure and will only be used for attendance tracking.</p>
    </div>
</div>

{% block scripts %}
<script>
// Assign meeting location and radius as JS variables using Jinja and parseFloat/parseInt
var meetingLat = parseFloat("{{ active_location.latitude|default(0) }}");
var meetingLon = parseFloat("{{ active_location.longitude|default(0) }}");
var allowedRadius = parseInt("{{ active_location.radius_meters|default(30) }}");
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('firstname').focus();
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    let isSubmitting = false;
    let locationDetected = false;
    let withinRadius = false;
    const locationError = document.getElementById('locationError');
    const distanceInfo = document.getElementById('distanceInfo');

    function calculateDistance(lat1, lon1, lat2, lon2) {
        // Haversine formula
        const toRad = x => x * Math.PI / 180;
        const R = 6371000; // meters
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function setLocation(lat, lon) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lon;
        locationDetected = true;
        locationError.style.display = 'none';
        // Calculate distance
        const distance = calculateDistance(meetingLat, meetingLon, lat, lon);
        if (distance <= allowedRadius) {
            withinRadius = true;
            distanceInfo.style.display = 'block';
            distanceInfo.style.background = '#d4edda';
            distanceInfo.style.color = '#155724';
            distanceInfo.innerHTML = `‚úÖ You are within ${allowedRadius} meters of the meeting location. (<b>${distance.toFixed(1)}m</b> away)`;
            submitBtn.disabled = false;
        } else {
            withinRadius = false;
            distanceInfo.style.display = 'block';
            distanceInfo.style.background = '#f8d7da';
            distanceInfo.style.color = '#721c24';
            distanceInfo.innerHTML = `‚ùå You are <b>${distance.toFixed(1)}m</b> away. You must be within <b>${allowedRadius}m</b> to sign attendance.`;
            submitBtn.disabled = true;
        }
    }
    function showLocationError() {
        locationError.style.display = 'block';
        distanceInfo.style.display = 'none';
        submitBtn.disabled = true;
    }
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            setLocation(pos.coords.latitude, pos.coords.longitude);
        }, function(err) {
            showLocationError();
        }, { enableHighAccuracy: false, timeout: 15000 });
    } else {
        showLocationError();
    }

    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }
        // Block submission if location not detected or not within radius
        if (!locationDetected) {
            e.preventDefault();
            showLocationError();
            return false;
        }
        if (!withinRadius) {
            e.preventDefault();
            distanceInfo.style.display = 'block';
            distanceInfo.style.background = '#f8d7da';
            distanceInfo.style.color = '#721c24';
            distanceInfo.innerHTML = `‚ùå You are not within the required radius to sign attendance.`;
            submitBtn.disabled = true;
            return false;
        }
        isSubmitting = true;
        submitBtn.innerHTML = '‚è≥ Submitting...';
        submitBtn.disabled = true;
        console.log('Form is submitting...');
    });
});
</script>
{% endblock %}
{% endblock %}